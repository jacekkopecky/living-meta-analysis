# LiMA deployment

We deploy LiMA on Google App Engine.

------------------
## Server `lima`

We expect LiMA to be installed on a machine that supports the below requirements. LiMA has been designed to use Google App Engine and Google Datastore, however can run on different hardware, whilst still connecting to Google Datastore.

### Requirements

- git
- node (we use 12.x)
- gcloud
- Google Cloud Project
  - Datastore
  - App Engine (optional)

### Setup

 1. clone the repo into your desired location
 2. `npm install`
 3. fill in google-datastore-specific settings in `server/config.js`
    - if using Google App Engine, the key is not required. Please ensure to set the Datastore Namespace however to the datastore you would like to use.
    - if not using Google App Engine, the above needs an authentication key pointed at by `config.gcloudProject.keyFilename` â€“ this is generated for you by the Google developer console
 4. change `webpages/js/auth.js` to include your own client ID also generated by Google
 5. fill in HTTPS settings, or comment out HTTPS-specific parts of `config.js` to run on HTTP only
    - If running on Google App Engine, HTTPS settings can be removed, as App Engine deals with SSL.
 6. `npm start` will run the server.

### Updating

commit in branch `production` to push to main service; commit to branch `master` to push to staging service.

The production is running at https://lima.soc.port.ac.uk

The staging service is at https://staging-dot-uop-soc-lima.ew.r.appspot.com/

### Invite Codes

You must first generate beta codes to access the site.
Generate beta codes by runing `npm run beta-codes`.
The script will ask you how many codes you want to geneate and to add an optional comment.
The beta codes will be saved to the datastore and printed out in a text file.

## Database

We use [Google Datastore](https://cloud.google.com/datastore/).

We have server-side datastore migrate script. They communicate directly with the datastore as configured in `config.js`.

### Migrate

The migrate script will convert the structure of the data to a new structure.
It is designed to be run once when the server of offline.

`npm run db-migrate`
