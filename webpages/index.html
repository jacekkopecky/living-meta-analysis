<!doctype html>
<title>LiMA – Living Meta-Analysis</title>
<script src="/lib/promise.js"></script>
<script src="/lib/fetch.js"></script>
<script src="https://apis.google.com/js/platform.js"></script>
<link rel="stylesheet" href="/css/main.css">

<header>
  <h1>LiMA (Living Meta-Analysis)</h1>

  <!-- this puts a sign-in button, and a sign-out link, in the page -->
  <div class="userinfo signedoff">
    <img src="/img/user.png" class="userphoto">
    <div class="actions">
      <div class="name when-signed-on">Signed in as: <span class="username"></span></div>
      <div class="g-signin2 signin"></div>
      <a href="/profile/" class="profile when-signed-on">Profile</a>
      <a href="#" class="signout when-signed-on">Sign out</a>
    </div>
  </div>
</header>

<p class="alert">
  LiMA is now in testing, thank you for taking part. Please send your thoughts and feedback to
  <a href="mailto:jacek.kopecky@port.ac.uk">jacek.kopecky@port.ac.uk</a>, or
  <a href="https://github.com/jacekkopecky/living-meta-analysis/issues">report and discuss issues on GitHub</a>.
</p>



<a class="when-signed-on" href="/profile">your profile</a>

<p class="when-signed-out"><a href="/lima@local/new-paper">create a new paper</a></p>

<p class="when-signed-out"><a href="/lima@local/new-metaanalysis">create a new metaanalysis</a></p>

<p>top users:</p>
<ol class="topusers"><li value="0">none</li></ol>


<p>top meta-analyses:</p>
<ol class="topmetaanalyses"><li value="0">none</li></ol>


<p>top papers:</p>
<ol class="toppapers"><li value="0">none</li></ol>

<footer>
  <p>LiMA (Living Meta-Analysis) at <a href="http://port.ac.uk/">University of Portsmouth</a>, &copy; 2016–2017</p>
  <p>Feedback and questions are welcome at <a href="mailto:lima@port.ac.uk">lima@port.ac.uk</a>.</p>
</footer>


<script src="/js/tools.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/version.js"></script>
<script>
window.lima.initPage = function () {
  // todo this is provisional

  var lima = window.lima;
  var _ = lima._;

  lima.getGapiIDToken()
  .then(function (idToken) {
    return fetch('/api/topusers', _.idTokenToFetchOptions(idToken));
  })
  .then(_.fetchJson)
  .then(showTopUsers)
  .catch(function (err) {
    console.error('can\'t load top users');
    console.error(err);
    _.apiFail();
  });

  lima.getGapiIDToken()
  .then(function (idToken) {
    return fetch('/api/toppapers', _.idTokenToFetchOptions(idToken));
  })
  .then(_.fetchJson)
  .then(showTopPapers)
  .catch(function (err) {
    console.error('can\'t load top papers');
    console.error(err);
    _.apiFail();
  });

  lima.getGapiIDToken()
  .then(function (idToken) {
    return fetch('/api/topmetaanalyses', _.idTokenToFetchOptions(idToken));
  })
  .then(_.fetchJson)
  .then(showTopMetaanalyses)
  .catch(function (err) {
    console.error('can\'t load top metaanalyses');
    console.error(err);
    _.apiFail();
  });

  function showTopUsers(users) {
    var list = _.findEl('.topusers');
    list.innerHTML = '';

    users.forEach(function (user) {
      var li = document.createElement('li');
      var userlink = document.createElement('a');
      userlink.href = '/' + user.email + '/';
      userlink.textContent = user.displayName;
      li.appendChild(userlink);
      list.appendChild(li);
    });
  }

  function showTopMetaanalyses(metaanalyses) {
    var list = _.findEl('.topmetaanalyses');
    list.innerHTML = '';

    metaanalyses.forEach(function (metaanalysis) {
      var li = document.createElement('li');
      var metaanalysislink = document.createElement('a');
      metaanalysislink.href = '/' + metaanalysis.enteredBy + '/' + metaanalysis.title + '/';
      metaanalysislink.textContent = metaanalysis.title;
      li.appendChild(metaanalysislink);
      list.appendChild(li);
    });
  }

  function showTopPapers(papers) {
    var list = _.findEl('.toppapers');
    list.innerHTML = '';

    papers.forEach(function (paper) {
      var li = document.createElement('li');
      var paperlink = document.createElement('a');
      paperlink.href = '/' + paper.enteredBy + '/' + paper.title + '/';
      paperlink.textContent = paper.title;
      li.appendChild(paperlink);
      list.appendChild(li);
    });
  }
};

</script>
